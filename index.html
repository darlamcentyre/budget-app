<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Budget">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="icon" type="image/png" href="icon-192.png">
<meta name="theme-color" content="#2fd3cb">
<title>Monthly Budget Tracker</title>

<style>
/* --- SAME STYLES AS YOUR ORIGINAL --- */
:root{
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  --bg1:#bff7f2;
  --bg2:#63e6df;
  --bg3:#2fd3cb;
  --card:rgba(255,255,255,.92);
  --border:rgba(232,238,247,.95);
  --text:#163243;
  --muted:#4b6b7e;
  --teal:#0ea5a7;
  --teal2:#14b8c4;
  --purple:#7c3aed;
  --red:#ef4444;
  --red2:#dc2626;
  --green:#22c55e;
  --green2:#16a34a;
  --paidRow:#eafff3;
  --unpaidRow:#ffecec;
  --overdueRow:#fff2cc;
  --shadow: 0 12px 30px rgba(10,35,50,0.16);
}
body{
  margin:24px;
  background:linear-gradient(135deg,var(--bg1),var(--bg2) 45%,var(--bg3));
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  color:var(--text);
}
.card{background:var(--card);border-radius:16px;padding:18px;margin-bottom:18px;box-shadow:var(--shadow);}
button{cursor:pointer;font-weight:700;border:none;padding:8px 14px;border-radius:10px;}
.btn-primary{background:linear-gradient(90deg,var(--teal),var(--teal2));color:white;}
.btn-secondary{background:linear-gradient(90deg,var(--purple),#a855f7);color:white;}
.btn-danger{background:linear-gradient(90deg,var(--red),var(--red2));color:white;}
.badge{display:inline-block;margin-right:12px;font-weight:700;}
</style>
</head>

<body>

<h2>Monthly Budget Tracker</h2>

<div class="card">
<b>Totals</b><br><br>
<span class="badge">Income: <span id="totalIncome">$0.00</span></span>
<span class="badge">Total owed: <span id="totalOwed">$0.00</span></span>
<span class="badge">Left after paid: <span id="leftAfterPaid">$0.00</span></span>
<span class="badge">Paid total: <span id="paidTotal">$0.00</span></span>
</div>

<script>
(() => {

const STORAGE_KEY="budget_app_state_v5";

let state=loadState();

function parseNumberLoose(v){
  if(typeof v==="number") return v;
  const cleaned=String(v||"").replace(/[^0-9.\-]/g,"");
  const n=Number(cleaned);
  return Number.isFinite(n)?n:0;
}

function normalizeBillAmount(raw){
  const n=Number(raw);
  if(!Number.isFinite(n)) return 0;
  return Math.abs(n);
}

function fmtMoney(n){
  return Number(n||0).toLocaleString(undefined,{style:"currency",currency:"USD"});
}

/* -------- SAFE TOTALS -------- */
function totals(){
  const totalIncome=state.incomes.reduce((s,i)=>s+parseNumberLoose(i.amount),0);
  const totalOwed=state.bills.filter(b=>!b.paid)
    .reduce((s,b)=>s+normalizeBillAmount(b.amount),0);
  const paidTotal=state.bills.filter(b=>b.paid)
    .reduce((s,b)=>s+normalizeBillAmount(b.amount),0);
  const leftAfterPaid=totalIncome-paidTotal;
  return{totalIncome,totalOwed,paidTotal,leftAfterPaid};
}

function saveState(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
}

function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return{incomes:[],bills:[]};
    const p=JSON.parse(raw);
    return{
      incomes:(p.incomes||[]).map(i=>({...i,amount:parseNumberLoose(i.amount)})),
      bills:(p.bills||[]).map(b=>({...b,amount:normalizeBillAmount(b.amount)}))
    };
  }catch{
    return{incomes:[],bills:[]};
  }
}

/* ---------- SAFE IMPORT (REPLACE OPTION) ---------- */
window.importBillsSafe=function(rows){
  const replace=confirm("Replace current bills?\nOK = Replace\nCancel = Append");
  if(replace) state.bills=[];
  rows.forEach(r=>{
    state.bills.push({
      id:crypto.randomUUID(),
      name:r.name,
      dueDay:r.dueDay,
      amount:normalizeBillAmount(r.amount),
      paid:!!r.paid,
      recurring:!!r.recurring
    });
  });
  render();
};

/* ---------- RENDER ---------- */
function render(){
  const t=totals();
  document.getElementById("totalIncome").textContent=fmtMoney(t.totalIncome);
  document.getElementById("totalOwed").textContent=fmtMoney(t.totalOwed);
  document.getElementById("paidTotal").textContent=fmtMoney(t.paidTotal);
  document.getElementById("leftAfterPaid").textContent=fmtMoney(t.leftAfterPaid);
  saveState();
}

render();

})();
</script>

</body>
</html>
