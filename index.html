<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- iPhone “app-like” + icon -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Budget">
<link rel="apple-touch-icon" href="icon-180.png">
<link rel="icon" type="image/png" href="icon-192.png">
<meta name="theme-color" content="#2fd3cb">

<title>Monthly Budget Tracker</title>

<style>
:root{
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;

  --bg1:#bff7f2;
  --bg2:#63e6df;
  --bg3:#2fd3cb;

  --card:rgba(255,255,255,.92);
  --border:rgba(232,238,247,.95);
  --text:#163243;
  --muted:#4b6b7e;

  --teal:#0ea5a7;
  --teal2:#14b8c4;
  --purple:#7c3aed;

  --red:#ef4444;
  --red2:#dc2626;

  --green:#22c55e;
  --green2:#16a34a;

  --paidRow:#eafff3;
  --paidRowHover:#d6ffe8;
  --unpaidRow:#ffecec;
  --unpaidRowHover:#ffdcdc;
  --overdueRow:#fff2cc;
  --overdueRowHover:#ffe8a3;

  --shadow: 0 12px 30px rgba(10,35,50,0.16);
}

*{ box-sizing:border-box; }

body{
  margin: 24px;
  color: var(--text);
  background:
    radial-gradient(900px 520px at 15% 0%, rgba(255,255,255,0.55), transparent 55%),
    radial-gradient(900px 520px at 85% 10%, rgba(255,255,255,0.35), transparent 55%),
    radial-gradient(900px 520px at 50% 110%, rgba(124,58,237,0.10), transparent 60%),
    linear-gradient(135deg, var(--bg1), var(--bg2) 45%, var(--bg3));
  min-height: 100vh;
}

.wrap{ max-width: 1200px; margin: 0 auto; }

h1{ margin: 0 0 6px; font-size: 30px; letter-spacing: .2px; }
.mini{ font-size: 12px; color: rgba(22,50,67,0.85); font-weight: 750; }

.topbar{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:flex-end;
  justify-content:space-between;
  margin-bottom:14px;
}

.card{
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 18px;
  box-shadow: var(--shadow);
  margin-bottom: 18px;
  backdrop-filter: blur(6px);
}

.row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
.spacer{ flex:1; }

label{
  font-size: 12px;
  color: var(--muted);
  display:block;
  margin-bottom:6px;
  font-weight: 850;
  letter-spacing: .2px;
}

input, select, button, textarea{
  border-radius: 12px;
  border: 1px solid rgba(219,230,251,0.95);
  background: #ffffff;
  color: var(--text);
  padding: 10px 12px;
  font-size: 14px;
}

textarea{ resize:vertical; min-height: 72px; }

input:focus, select:focus, textarea:focus{
  outline:none;
  border-color: rgba(20,184,196,0.95);
  box-shadow: 0 0 0 3px rgba(20,184,196,0.22);
}

button{
  cursor:pointer;
  font-weight: 950;
  transition: transform 0.15s ease, filter 0.15s ease;
  border: 0;
  white-space: nowrap;
}
button:hover{ transform: translateY(-1px); filter: brightness(1.02); }

.btn-primary{
  background: linear-gradient(90deg, var(--teal), var(--teal2));
  color: white;
  box-shadow: 0 10px 18px rgba(14,165,167,0.22);
}
.btn-danger{
  background: linear-gradient(90deg, var(--red), var(--red2));
  color: white;
  box-shadow: 0 10px 18px rgba(220,38,38,0.18);
}
.btn-secondary{
  background: linear-gradient(90deg, var(--purple), #a855f7);
  color: white;
  box-shadow: 0 10px 18px rgba(124,58,237,0.16);
}
.btn-ghost{
  background: rgba(255,255,255,0.85);
  border: 1px solid rgba(219,230,251,0.95);
  color: var(--text);
  box-shadow: 0 8px 16px rgba(10,35,50,0.10);
}

.badges{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:flex-end;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(232,238,247,0.95);
  background: rgba(255,255,255,0.95);
  box-shadow: 0 8px 18px rgba(10,35,50,0.10);
  font-weight: 950;
}
.badge .label{ font-size: 12px; color: var(--muted); }
.badge .value{ font-size: 14px; }

.badge.income .value{ color: var(--teal); }
.badge.owed .value{ color: var(--red2); }
.badge.left .value{ color: var(--green2); }
.badge.paidtotal .value{ color: var(--purple); }

h3{
  margin: 0 0 10px;
  font-size: 18px;
  background: linear-gradient(90deg, var(--teal), var(--purple));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

.smallhint{ font-size: 12px; color: rgba(75,107,126,0.95); font-weight: 750; margin-top: 8px; }

table{ width:100%; border-collapse: collapse; }
th, td{ padding: 12px; border-bottom: 1px solid rgba(238,242,250,0.95); vertical-align: middle; }
th{
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: rgba(75,107,126,0.95);
}

tr.unpaid{ background: var(--unpaidRow); }
tr.unpaid:hover{ background: var(--unpaidRowHover); }

tr.paid{ background: var(--paidRow); }
tr.paid:hover{ background: var(--paidRowHover); }

tr.overdue{ background: var(--overdueRow); }
tr.overdue:hover{ background: var(--overdueRowHover); }

.pill{
  display:inline-block;
  padding: 5px 12px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 1000;
  color: white;
}
.pill.paid{ background: linear-gradient(90deg, var(--green), var(--green2)); }
.pill.unpaid{ background: linear-gradient(90deg, var(--red), var(--red2)); }
.pill.overdue{ background: linear-gradient(90deg, #f59e0b, #d97706); }
.pill.recurring{ background: linear-gradient(90deg, var(--purple), #a855f7); }

.actions button{ margin-right: 8px; margin-bottom: 6px; }

.section-title{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}

.checkbox{
  display:flex;
  align-items:center;
  gap:8px;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(219,230,251,0.95);
  background: rgba(255,255,255,0.9);
}
.checkbox input{ width: 16px; height: 16px; }

/* Splash screen */
.splash{
  position: fixed;
  inset: 0;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap: 14px;
  background:
    radial-gradient(900px 520px at 15% 0%, rgba(255,255,255,0.55), transparent 55%),
    radial-gradient(900px 520px at 85% 10%, rgba(255,255,255,0.35), transparent 55%),
    linear-gradient(135deg, var(--bg1), var(--bg2) 45%, var(--bg3));
  z-index: 9999;
}
.splash .logo{
  width: 120px;
  height: 120px;
  border-radius: 999px;
  background: var(--bg3);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 18px 40px rgba(10,35,50,0.18);
  position: relative;
}
.splash .logo::after{
  content:"$";
  font-size: 64px;
  font-weight: 1000;
  color: var(--purple);
  text-shadow: 0 2px 0 rgba(255,255,255,0.6);
}
.splash .title{
  font-size: 22px;
  font-weight: 1000;
  color: rgba(22,50,67,0.95);
  letter-spacing: 0.2px;
}
.splash .subtitle{
  font-size: 13px;
  font-weight: 800;
  color: rgba(75,107,126,0.95);
}
.splash.hide{
  opacity: 0;
  pointer-events: none;
  transition: opacity 350ms ease;
}

/* Modal */
.modal-backdrop{
  position:fixed; inset:0;
  background: rgba(0,0,0,0.25);
  display:none;
  align-items:center;
  justify-content:center;
  padding: 18px;
  z-index: 9998;
}
.modal{
  width:min(720px, 100%);
  background: rgba(255,255,255,0.96);
  border: 1px solid rgba(232,238,247,0.95);
  border-radius: 18px;
  box-shadow: 0 20px 60px rgba(10,35,50,0.35);
  padding: 16px;
}
.modal h4{ margin: 0 0 10px; font-size: 16px; }
.modal .row{ align-items:flex-end; }
.modal .footer{
  display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
  margin-top: 12px;
}

/* Printable summary */
.print-summary{ display:none; }
@media print{
  body{ margin: 0; background:#fff !important; }
  .no-print{ display:none !important; }
  .print-summary{ display:block !important; }
  .card{ box-shadow:none !important; border:none !important; background:transparent !important; padding:0 !important; margin:0 !important; }
}

/* ===== Mobile-friendly bills table ===== */
@media (max-width: 820px){
  body{ margin: 12px; }
  .card{ padding: 14px; }
  h1{ font-size: 26px; }

  /* Stack bills table into card rows */
  table.responsive thead{ display:none; }
  table.responsive, table.responsive tbody, table.responsive tr, table.responsive td{
    display:block; width:100%;
  }
  table.responsive tr{
    border: 1px solid rgba(232,238,247,0.95);
    border-radius: 16px;
    margin: 12px 0;
    overflow:hidden;
  }
  table.responsive td{
    border-bottom: 1px solid rgba(238,242,250,0.95);
    display:flex;
    justify-content:space-between;
    gap:12px;
    padding: 10px 12px;
  }
  table.responsive td:last-child{ border-bottom:none; }
  table.responsive td::before{
    content: attr(data-label);
    font-size: 12px;
    font-weight: 900;
    color: rgba(75,107,126,0.95);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .actions{
    display:flex;
    flex-direction:column;
    gap:10px;
    align-items:stretch;
  }
  .actions button{ width:100%; margin:0; }
}
</style>
</head>

<body>

<div class="splash" id="splash">
  <div class="logo" aria-hidden="true"></div>
  <div class="title">Budget</div>
  <div class="subtitle">Monthly bills + income</div>
</div>

<div class="wrap">

  <div class="topbar no-print">
    <div>
      <h1>Monthly Budget Tracker</h1>
      <div class="mini">Due day = 1–31 • Sorted least → most • Total owed decreases as you mark bills paid • Overdue highlights automatically</div>
    </div>

    <div class="row">
      <div>
        <label>Month label</label>
        <input id="monthLabel" placeholder="e.g., March 2026" style="min-width:220px;" />
      </div>

      <button class="btn-secondary" id="printBtn" type="button">Printable Summary</button>

      <button class="btn-secondary" id="saveBtn" type="button">Save Month</button>
      <input id="loadFile" type="file" accept=".json" style="display:none;">
      <button class="btn-secondary" id="loadBtn" type="button">Load Month</button>

      <button class="btn-danger" id="newBtn" type="button" title="Clears month but keeps recurring bills (unpaid)">New Month (carry recurring)</button>
    </div>
  </div>

  <!-- Totals -->
  <div class="card no-print">
    <div class="section-title">
      <h3 style="margin:0;">Totals</h3>
      <div class="badges">
        <div class="badge income"><span class="label">Income:</span><span class="value" id="totalIncome">$0.00</span></div>
        <div class="badge owed"><span class="label">Total owed:</span><span class="value" id="totalOwed">$0.00</span></div>
        <div class="badge left"><span class="label">Left if on budget:</span><span class="value" id="leftIfOnBudget">$0.00</span></div>
        <div class="badge paidtotal"><span class="label">Paid total:</span><span class="value" id="paidTotal">$0.00</span></div>
      </div>
    </div>
    <div class="smallhint">Marking a bill paid subtracts it from “Total owed” automatically.</div>
  </div>

  <!-- Income -->
  <div class="card no-print">
    <div class="section-title">
      <h3 style="margin:0;">Income</h3>
      <div class="mini">Add monthly income sources (paychecks, rentals, side income, etc.).</div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Source</label>
        <input id="incomeSource" placeholder="Work, Side gig, Rental, etc." style="min-width:240px;" />
      </div>
      <div>
        <label>Amount</label>
        <input id="incomeAmount" type="number" step="0.01" placeholder="0.00" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn-primary" id="addIncome" type="button">Add Income</button>
      </div>
      <div class="spacer"></div>
      <div>
        <label>&nbsp;</label>
        <button class="btn-ghost" id="clearIncome" type="button">Clear Income</button>
      </div>
    </div>

    <div style="overflow:auto; margin-top:12px;">
      <table>
        <thead>
          <tr><th>Source</th><th>Amount</th><th>Actions</th></tr>
        </thead>
        <tbody id="incomeTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Bills -->
  <div class="card no-print">
    <div class="section-title">
      <h3 style="margin:0;">Bills</h3>
      <div class="mini">Import your bills, then edit any amounts/due days right here.</div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div>
        <label>Bill name</label>
        <input id="billName" placeholder="Power, Mortgage, etc." style="min-width:240px;" />
      </div>
      <div>
        <label>Due day (1–31)</label>
        <input id="billDue" type="number" min="1" max="31" placeholder="1" />
      </div>
      <div>
        <label>Amount</label>
        <input id="billAmt" type="number" step="0.01" placeholder="0.00" />
      </div>
      <div class="checkbox" title="Recurring bills carry forward to new month">
        <input id="billRecurring" type="checkbox" />
        <label for="billRecurring" style="margin:0; font-size:12px; color:var(--muted);">Recurring</label>
      </div>
      <div style="min-width:260px; flex: 1;">
        <label>Notes</label>
        <input id="billNotes" placeholder="optional" style="width:100%;" />
      </div>

      <div class="spacer"></div>
      <button class="btn-primary" id="addBill" type="button">Add Bill</button>
      <button class="btn-danger" id="clearBills" type="button">Clear Bills</button>
    </div>

    <hr style="margin:18px 0; border:none; border-top:1px solid rgba(232,238,247,0.95);">

    <div class="row" style="align-items:end;">
      <div>
        <label>Upload Excel / CSV</label>
        <input id="importFile" type="file" accept=".xlsx,.xls,.csv" />
      </div>
      <button class="btn-secondary" id="importBtn" type="button">Import</button>

      <div class="spacer"></div>

      <div>
        <label>Filter</label>
        <select id="filter">
          <option value="all">All</option>
          <option value="unpaid">Unpaid</option>
          <option value="paid">Paid</option>
        </select>
      </div>

      <button class="btn-secondary" id="exportBtn" type="button">Export CSV</button>
    </div>

    <div class="smallhint">
      Supported headers (any case/spaces): <b>Name</b>, <b>DueDay</b> or <b>DueDate</b> (we keep day only),
      <b>Amount</b>, <b>Notes</b>, <b>Paid</b>, <b>Recurring</b>.
      If amounts are negative in your sheet, we convert to positive “amount owed.”
    </div>

    <div style="overflow:auto; margin-top:12px;">
      <table class="responsive" id="billsTable">
        <thead>
          <tr>
            <th>Status</th>
            <th>Bill</th>
            <th>Due day</th>
            <th>Amount</th>
            <th>Notes</th>
            <th>Recurring</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="billsTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Printable Summary (simple) -->
  <div class="print-summary" id="printSummary">
    <h2 id="printTitle">Monthly Summary</h2>
    <div id="printMeta" style="font-size:12px;color:#374151;margin-bottom:10px;"></div>
    <div id="printTotals" style="font-weight:900;margin:12px 0;"></div>
    <h3 style="color:#111827;background:none;-webkit-text-fill-color:initial;">Income</h3>
    <div id="printIncome"></div>
    <h3 style="color:#111827;background:none;-webkit-text-fill-color:initial;margin-top:16px;">Bills</h3>
    <div id="printBills"></div>
  </div>

</div>

<!-- Modal for editing bills -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h4 id="modalTitle">Edit Bill</h4>

    <div class="row">
      <div style="min-width:220px; flex:1;">
        <label>Bill name</label>
        <input id="editName" />
      </div>
      <div style="width:140px;">
        <label>Due day (1–31)</label>
        <input id="editDue" type="number" min="1" max="31" />
      </div>
      <div style="width:160px;">
        <label>Amount</label>
        <input id="editAmt" type="number" step="0.01" />
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Notes</label>
      <textarea id="editNotes"></textarea>
    </div>

    <div class="row" style="margin-top:10px;">
      <div class="checkbox">
        <input id="editPaid" type="checkbox">
        <label for="editPaid" style="margin:0;">Paid</label>
      </div>
      <div class="checkbox">
        <input id="editRecurring" type="checkbox">
        <label for="editRecurring" style="margin:0;">Recurring</label>
      </div>
      <div class="spacer"></div>
    </div>

    <div class="footer">
      <button class="btn-ghost" id="cancelEdit" type="button">Cancel</button>
      <button class="btn-secondary" id="saveEdit" type="button">Save Changes</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
(() => {
  const STORAGE_KEY = "budget_app_state_v2";

  let state = loadState();
  let editingId = null;

  // Elements
  const monthLabelEl = document.getElementById("monthLabel");

  const totalIncomeEl = document.getElementById("totalIncome");
  const totalOwedEl = document.getElementById("totalOwed");
  const leftIfOnBudgetEl = document.getElementById("leftIfOnBudget");
  const paidTotalEl = document.getElementById("paidTotal");

  const incomeSourceEl = document.getElementById("incomeSource");
  const incomeAmountEl = document.getElementById("incomeAmount");
  const incomeTbody = document.getElementById("incomeTbody");

  const billNameEl = document.getElementById("billName");
  const billDueEl = document.getElementById("billDue");
  const billAmtEl = document.getElementById("billAmt");
  const billNotesEl = document.getElementById("billNotes");
  const billRecurringEl = document.getElementById("billRecurring");

  const billsTbody = document.getElementById("billsTbody");
  const filterEl = document.getElementById("filter");
  const importFileEl = document.getElementById("importFile");

  // Buttons
  document.getElementById("addIncome").addEventListener("click", addIncome);
  document.getElementById("clearIncome").addEventListener("click", clearIncome);

  document.getElementById("addBill").addEventListener("click", addBill);
  document.getElementById("clearBills").addEventListener("click", clearBills);

  document.getElementById("importBtn").addEventListener("click", importBills);
  document.getElementById("exportBtn").addEventListener("click", exportCSV);

  document.getElementById("saveBtn").addEventListener("click", saveMonthFile);
  document.getElementById("loadBtn").addEventListener("click", () => document.getElementById("loadFile").click());
  document.getElementById("loadFile").addEventListener("change", loadMonthFile);
  document.getElementById("newBtn").addEventListener("click", newMonthCarryRecurring);

  document.getElementById("printBtn").addEventListener("click", printSummary);
  filterEl.addEventListener("change", render);

  monthLabelEl.addEventListener("input", () => { state.monthLabel = monthLabelEl.value.trim(); saveState(); });

  // Modal elements
  const modalBackdrop = document.getElementById("modalBackdrop");
  const editNameEl = document.getElementById("editName");
  const editDueEl = document.getElementById("editDue");
  const editAmtEl = document.getElementById("editAmt");
  const editNotesEl = document.getElementById("editNotes");
  const editPaidEl = document.getElementById("editPaid");
  const editRecurringEl = document.getElementById("editRecurring");
  document.getElementById("cancelEdit").addEventListener("click", closeModal);
  document.getElementById("saveEdit").addEventListener("click", saveEdit);

  // Helpers
  function uid(){
    return (crypto?.randomUUID?.() || ("id-" + Math.random().toString(16).slice(2)));
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function fmtMoney(n){
    const v = Number(n);
    const safe = Number.isFinite(v) ? v : 0;
    return safe.toLocaleString(undefined, { style:"currency", currency:"USD" });
  }

  // Treat owed amount as positive
  function owedAmount(raw){
    const n = Number(raw);
    if(!Number.isFinite(n)) return 0;
    return Math.abs(n);
  }

  function todayDay(){
    return new Date().getDate();
  }

  function overdue(b){
    const d = Number(b.dueDay);
    if(!Number.isFinite(d) || d < 1 || d > 31) return false;
    return !b.paid && d < todayDay();
  }

  function cleanDue(d){
    const n = Number(d);
    if(Number.isFinite(n) && n >= 1 && n <= 31) return Math.trunc(n);
    return 999;
  }

  function totals(){
    const totalIncome = state.incomes.reduce((s,i)=> s + (Number(i.amount)||0), 0);
    const totalOwed = state.bills.filter(b=>!b.paid).reduce((s,b)=> s + owedAmount(b.amount), 0);
    const paidTotal = state.bills.filter(b=>b.paid).reduce((s,b)=> s + owedAmount(b.amount), 0);
    return { totalIncome, totalOwed, paidTotal, left: totalIncome - totalOwed };
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { monthLabel:"", incomes:[], bills:[] };
      const p = JSON.parse(raw);
      return {
        monthLabel: String(p.monthLabel || ""),
        incomes: Array.isArray(p.incomes) ? p.incomes : [],
        bills: Array.isArray(p.bills) ? p.bills : []
      };
    }catch{
      return { monthLabel:"", incomes:[], bills:[] };
    }
  }

  // Income
  function addIncome(){
    const source = incomeSourceEl.value.trim();
    const amount = Number(incomeAmountEl.value || 0);
    if(!source) return alert("Enter an income source.");
    if(!Number.isFinite(amount)) return alert("Enter a valid income amount.");

    state.incomes.push({ id: uid(), source, amount });
    incomeSourceEl.value = "";
    incomeAmountEl.value = "";
    render();
  }

  function clearIncome(){
    if(confirm("Clear all income lines?")){
      state.incomes = [];
      render();
    }
  }

  window.deleteIncome = function(id){
    state.incomes = state.incomes.filter(i => i.id !== id);
    render();
  };

  // Bills
  function addBill(){
    const name = billNameEl.value.trim();
    const dueDay = Number(billDueEl.value);
    const amount = Number(billAmtEl.value || 0);
    const notes = billNotesEl.value.trim();
    const recurring = !!billRecurringEl.checked;

    if(!name) return alert("Please enter a bill name.");
    if(!Number.isFinite(dueDay) || dueDay < 1 || dueDay > 31) return alert("Due day must be 1–31.");

    state.bills.push({ id: uid(), name, dueDay, amount, notes, recurring, paid:false });

    billNameEl.value = "";
    billDueEl.value = "";
    billAmtEl.value = "";
    billNotesEl.value = "";
    billRecurringEl.checked = false;
    render();
  }

  function clearBills(){
    if(confirm("Clear all bills?")){
      state.bills = [];
      render();
    }
  }

  window.togglePaid = function(id){
    const b = state.bills.find(x => x.id === id);
    if(!b) return;
    b.paid = !b.paid;
    render();
  };

  window.toggleRecurring = function(id){
    const b = state.bills.find(x => x.id === id);
    if(!b) return;
    b.recurring = !b.recurring;
    render();
  };

  window.deleteBill = function(id){
    state.bills = state.bills.filter(b => b.id !== id);
    render();
  };

  window.editBill = function(id){
    const b = state.bills.find(x => x.id === id);
    if(!b) return;

    editingId = id;
    editNameEl.value = b.name || "";
    editDueEl.value = (b.dueDay ?? "");
    editAmtEl.value = (Number(b.amount) || 0);
    editNotesEl.value = b.notes || "";
    editPaidEl.checked = !!b.paid;
    editRecurringEl.checked = !!b.recurring;

    modalBackdrop.style.display = "flex";
    modalBackdrop.setAttribute("aria-hidden","false");
  };

  function closeModal(){
    editingId = null;
    modalBackdrop.style.display = "none";
    modalBackdrop.setAttribute("aria-hidden","true");
  }

  function saveEdit(){
    const b = state.bills.find(x => x.id === editingId);
    if(!b) return closeModal();

    const name = editNameEl.value.trim();
    const dueDay = Number(editDueEl.value);
    const amount = Number(editAmtEl.value || 0);
    const notes = editNotesEl.value.trim();

    if(!name) return alert("Bill name is required.");
    if(!Number.isFinite(dueDay) || dueDay < 1 || dueDay > 31) return alert("Due day must be 1–31.");

    b.name = name;
    b.dueDay = dueDay;
    b.amount = amount;
    b.notes = notes;
    b.paid = !!editPaidEl.checked;
    b.recurring = !!editRecurringEl.checked;

    closeModal();
    render();
  }

  // Month save/load
  function saveMonthFile(){
    state.monthLabel = monthLabelEl.value.trim();

    const payload = {
      app: "BudgetApp",
      version: 2,
      savedAt: new Date().toISOString(),
      monthLabel: state.monthLabel || "",
      incomes: state.incomes,
      bills: state.bills
    };

    const filenameSafe = (state.monthLabel || "Month")
      .replace(/[^\w\- ]+/g, "")
      .trim()
      .replace(/\s+/g, "-");

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${filenameSafe}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  async function loadMonthFile(e){
    const file = e.target.files?.[0];
    if(!file) return;

    try{
      const txt = await file.text();
      const data = JSON.parse(txt);

      state = {
        monthLabel: String(data.monthLabel || ""),
        incomes: Array.isArray(data.incomes) ? data.incomes : [],
        bills: Array.isArray(data.bills) ? data.bills : []
      };

      render();
      alert("Month loaded.");
    }catch{
      alert("Could not load that file. Make sure it is a JSON saved from this tracker.");
    }finally{
      e.target.value = "";
    }
  }

  function newMonthCarryRecurring(){
    if(!confirm("Start a NEW month?\n- Clears Income\n- Clears non-recurring bills\n- Carries recurring bills forward (unpaid)\nTip: Save Month first.")) return;

    const carried = state.bills
      .filter(b => b.recurring)
      .map(b => ({ ...b, id: uid(), paid:false }));

    state = { monthLabel: state.monthLabel || "", incomes: [], bills: carried };
    render();
  }

  // Import
  function normKey(k){
    return String(k || "").trim().toLowerCase().replace(/[^a-z0-9]/g,"");
  }

  function parseBool(v){
    if(v === true) return true;
    const s = String(v ?? "").trim().toLowerCase();
    return s === "true" || s === "yes" || s === "1" || s === "y" || s === "paid";
  }

  function parseAmount(v){
    if(typeof v === "number") return v;
    const cleaned = String(v || "").replace(/[^0-9.\-]/g,"");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function parseDueDay(v){
    if(typeof v === "number" && v >= 1 && v <= 31) return Math.trunc(v);

    if(typeof v === "string" && /^\d{1,2}$/.test(v.trim())){
      const n = Number(v.trim());
      if(n >= 1 && n <= 31) return n;
    }

    // ISO date
    if(typeof v === "string" && /^\d{4}-\d{2}-\d{2}/.test(v.trim())){
      const d = new Date(v.trim());
      if(!isNaN(d)) return d.getDate();
    }

    // US date mm/dd/yyyy -> keep dd
    if(typeof v === "string" && /^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(v.trim())){
      const parts = v.trim().split("/");
      const dd = Number(parts[1]);
      if(Number.isFinite(dd) && dd >= 1 && dd <= 31) return dd;
    }

    // Date object
    if(v instanceof Date && !isNaN(v)) return v.getDate();

    // Excel serial (date)
    if(typeof v === "number" && v > 31){
      const d = XLSX.SSF.parse_date_code(v);
      if(d && d.d >= 1 && d.d <= 31) return d.d;
    }

    return null;
  }

  function pick(map, keys){
    for(const k of keys){
      const nk = normKey(k);
      if(nk in map && String(map[nk]).trim() !== "") return map[nk];
    }
    return "";
  }

  async function importBills(){
    const file = importFileEl.files?.[0];
    if(!file) return alert("Select an Excel/CSV file first.");

    try{
      if(file.name.toLowerCase().endsWith(".csv")){
        const text = await file.text();
        importFromCSV(text);
        render();
        alert("Import complete.");
        return;
      }

      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { cellDates:true });
      const sheet = wb.Sheets[wb.SheetNames[0]];

      const rows = XLSX.utils.sheet_to_json(sheet, { defval:"" });
      if(rows.length === 0){
        const aoa = XLSX.utils.sheet_to_json(sheet, { header:1, defval:"" });
        importFromAOA(aoa);
      }else{
        importFromRows(rows);
      }

      render();
      alert("Import complete.");
    }catch(err){
      console.error(err);
      alert("Import failed. Please check your file format (.xlsx/.xls/.csv).");
    } finally {
      importFileEl.value = "";
    }
  }

  function importFromRows(rows){
    for(const r of rows){
      const map = {};
      for(const key of Object.keys(r)) map[normKey(key)] = r[key];

      const name = String(pick(map, ["Name","Bill","BillName","Vendor","Payee"])).trim();
      if(!name) continue;

      const dueRaw = pick(map, ["DueDay","DueDate","Due","DateDue","NextDue","duedate","dueday"]);
      const dueDay = parseDueDay(dueRaw);

      const amountRaw = pick(map, ["Amount","Amt","amount"]);
      const amount = parseAmount(amountRaw);

      const notes = String(pick(map, ["Notes","Note","Memo"])).trim();

      const paid = parseBool(pick(map, ["Paid","Status"]));
      const recurring = parseBool(pick(map, ["Recurring","Repeat"]));

      // IMPORTANT: dueDay is required for sorting/view; skip if missing
      if(!dueDay) continue;

      state.bills.push({
        id: uid(),
        name,
        dueDay,
        amount,
        notes,
        recurring,
        paid
      });
    }
  }

  function importFromAOA(aoa){
    let headerRow = -1;
    for(let i=0;i<Math.min(aoa.length, 25);i++){
      const row = aoa[i].map(x => normKey(x));
      const hasName = row.includes("name");
      const hasAmount = row.includes("amount") || row.includes("amt");
      if(hasName && hasAmount){ headerRow = i; break; }
    }
    if(headerRow === -1) return;

    const headers = aoa[headerRow].map(h => normKey(h));
    for(let r=headerRow+1;r<aoa.length;r++){
      const row = aoa[r];
      if(!row || row.every(x => String(x).trim()==="")) continue;

      const obj = {};
      for(let c=0;c<headers.length;c++){
        if(headers[c]) obj[headers[c]] = row[c];
      }

      const name = String(obj["name"] ?? "").trim();
      if(!name) continue;

      const dueDay = parseDueDay(obj["dueday"] ?? obj["duedate"] ?? obj["due"]);
      if(!dueDay) continue;

      const amount = parseAmount(obj["amount"] ?? obj["amt"]);
      const notes = String(obj["notes"] ?? obj["note"] ?? obj["memo"] ?? "").trim();
      const paid = parseBool(obj["paid"] ?? obj["status"]);
      const recurring = parseBool(obj["recurring"] ?? obj["repeat"]);

      state.bills.push({ id: uid(), name, dueDay, amount, notes, recurring, paid });
    }
  }

  function importFromCSV(text){
    const lines = text.split(/\r?\n/).filter(l => l.trim().length);
    if(!lines.length) return;

    const headers = lines[0].split(",").map(h => h.trim());
    const rows = lines.slice(1).map(line => {
      const cols = line.split(",");
      const obj = {};
      headers.forEach((h,i)=> obj[h] = (cols[i] ?? "").trim());
      return obj;
    });
    importFromRows(rows);
  }

  // Export
  function exportCSV(){
    const headers = ["Name","DueDay","Amount","Notes","Paid","Recurring"];
    const safe = (v) => {
      const s = String(v ?? "");
      return /[",\n]/.test(s) ? `"${s.replaceAll('"','""')}"` : s;
    };

    const lines = [headers.join(",")];
    for(const b of state.bills){
      lines.push([
        safe(b.name),
        safe(b.dueDay ?? ""),
        safe(b.amount),
        safe(b.notes),
        safe(b.paid),
        safe(!!b.recurring)
      ].join(","));
    }

    const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "bills.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Print summary
  function printSummary(){
    const t = totals();
    const label = monthLabelEl.value.trim();
    document.getElementById("printTitle").textContent = label ? `Monthly Summary — ${label}` : "Monthly Summary";
    document.getElementById("printMeta").textContent = "Printed: " + new Date().toLocaleString();
    document.getElementById("printTotals").textContent =
      `Income: ${fmtMoney(t.totalIncome)}   |   Owed: ${fmtMoney(t.totalOwed)}   |   Left: ${fmtMoney(t.left)}   |   Paid: ${fmtMoney(t.paidTotal)}`;

    // income list
    const inc = state.incomes.length
      ? "<ul>" + state.incomes.map(i => `<li>${escapeHtml(i.source)} — ${fmtMoney(Number(i.amount||0))}</li>`).join("") + "</ul>"
      : "<div>No income entries</div>";
    document.getElementById("printIncome").innerHTML = inc;

    // bills list
    const sorted = [...state.bills].sort((a,b)=> cleanDue(a.dueDay) - cleanDue(b.dueDay));
    const bills = sorted.length
      ? "<ol>" + sorted.map(b => {
          const status = b.paid ? "PAID" : (overdue(b) ? "OVERDUE" : "UNPAID");
          return `<li><b>${escapeHtml(b.name)}</b> — Due ${escapeHtml(b.dueDay)} — ${fmtMoney(owedAmount(b.amount))} — ${status}${b.recurring ? " (recurring)" : ""}${b.notes ? ` — ${escapeHtml(b.notes)}` : ""}</li>`;
        }).join("") + "</ol>"
      : "<div>No bills</div>";
    document.getElementById("printBills").innerHTML = bills;

    window.print();
  }

  // Render
  function render(){
    monthLabelEl.value = state.monthLabel || "";

    // income table
    incomeTbody.innerHTML = "";
    for(const i of state.incomes){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(i.source)}</td>
        <td>${fmtMoney(Number(i.amount||0))}</td>
        <td><button class="btn-danger" type="button" onclick="deleteIncome('${i.id}')">Delete</button></td>
      `;
      incomeTbody.appendChild(tr);
    }

    // bills view
    let view = state.bills;
    const f = filterEl.value;
    if(f === "paid") view = state.bills.filter(b => b.paid);
    if(f === "unpaid") view = state.bills.filter(b => !b.paid);

    view = [...view].sort((a,b)=> cleanDue(a.dueDay) - cleanDue(b.dueDay));

    billsTbody.innerHTML = "";
    for(const b of view){
      const due = cleanDue(b.dueDay) === 999 ? "" : String(cleanDue(b.dueDay));
      const rowClass = b.paid ? "paid" : (overdue(b) ? "overdue" : "unpaid");

      const statusPill = b.paid
        ? `<span class="pill paid">PAID</span>`
        : overdue(b)
          ? `<span class="pill overdue">OVERDUE</span>`
          : `<span class="pill unpaid">UNPAID</span>`;

      const recurringPill = b.recurring
        ? `<span class="pill recurring">YES</span>`
        : `<span class="mini" style="font-weight:800;">—</span>`;

      const tr = document.createElement("tr");
      tr.className = rowClass;

      tr.innerHTML = `
        <td data-label="Status">${statusPill}</td>
        <td data-label="Bill">${escapeHtml(b.name)}</td>
        <td data-label="Due Day">${escapeHtml(due)}</td>
        <td data-label="Amount">${fmtMoney(owedAmount(b.amount))}</td>
        <td data-label="Notes">${escapeHtml(b.notes || "")}</td>
        <td data-label="Recurring">${recurringPill}</td>
        <td data-label="Actions" class="actions">
          <button class="btn-primary" type="button" onclick="togglePaid('${b.id}')">${b.paid ? "Mark Unpaid" : "Mark Paid"}</button>
          <button class="btn-secondary" type="button" onclick="editBill('${b.id}')">Edit</button>
          <button class="btn-secondary" type="button" onclick="toggleRecurring('${b.id}')">${b.recurring ? "Unmark Recurring" : "Make Recurring"}</button>
          <button class="btn-danger" type="button" onclick="deleteBill('${b.id}')">Delete</button>
        </td>
      `;
      billsTbody.appendChild(tr);
    }

    // totals
    const t = totals();
    totalIncomeEl.textContent = fmtMoney(t.totalIncome);
    totalOwedEl.textContent = fmtMoney(t.totalOwed);
    leftIfOnBudgetEl.textContent = fmtMoney(t.left);
    paidTotalEl.textContent = fmtMoney(t.paidTotal);

    saveState();
  }

  // Splash
  window.addEventListener("load", () => {
    const s = document.getElementById("splash");
    if(!s) return;
    setTimeout(() => s.classList.add("hide"), 450);
  });

  render();
})();
</script>

</body>
</html>
